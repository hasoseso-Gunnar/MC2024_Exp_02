<template>
  <p class="text-h5 text-black text-bold text-center q-mb-lg">オンラインでの対人コミュニケーションに関する調査</p>
  <p class="description">この度はお忙しい中、本調査にご協力いただきありがとうございます。</p>
  <p class="description">調査にご協力していただく前に、以下の説明をよく読み、ページ下部の質問に回答してください。</p>
  <br/>
  <p class="title">【本研究の目的】</p>
  <p class="description">本研究では、人々がオンラインでの対人コミュニケーションをどのように行うのかについて調べることを目的としています。</p>
  <br/>
  <p class="title">【本研究の参加対象者】</p>
  <p class="description">本研究は、日本国籍を持つ18歳以上・65歳以下の方が対象です。日本国籍を持たない方、18歳未満の方、66歳以上の方は参加できません。</p>
  <br/>
  <p class="title">【所要時間と回答方法】</p>
  <p class="description">調査の所要時間は約20分です。本調査はオンラインフォーム上のアンケートによって実施されます。</p>
  <p class="description">調査に参加していただく間は、指示に従っていくつかのアンケートに回答してください。</p>
  <p class="description">また、本調査への回答は、パソコン（Windows, Mac等）またはタブレット端末（iPad等）から行ってください。<span class="text-red-9 text-bold">回答に正解・不正解はありません</span>ので、それぞれの質問に素直にお答えください。</p>
  <p class="description">なお、本調査への参加はデバイス1台につき1回に制限されています。そのため、回答を途中で終了した場合でも再回答はできませんので、ご注意ください。</p>
  <br/>
  <p class="title">【本調査での回答上のお願い】</p>
  <p class="description text-red-9 text-bold">1. 調査への回答の最中に、「ページを再読み込みする」「ウィンドウを閉じる」などのブラウザ上の操作を行わないでください。</p>
  <p class="description">※正常に調査が完了しない場合や、回答の進捗が初期化されてしまう可能性があります。</p>
  <br/>
  <p class="description text-red-9 text-bold">2. 本調査では、途中で音が出る箇所がありますので、必ず端末のミュートを解除してください。</p>
  <p class="description">※イヤホンやヘッドホンを装着するか、周りに音を聞かれてもよい環境での回答を推奨します。</p>
  <p class="description">※また、音楽を聞きながらの回答も控えてください。</p>
  <br/>
  <p class="title">【調査内容】</p>
  <p class="description">本研究では、他者とペアを組んだ状態で、コミュニケーションを必要とする課題に取り組んでいただきます。また、課題の前後であなた個人の一般的な物事への考え方についても尋ねます。</p>
  <br/>
  <p class="title">【同意とその撤回について】</p>
  <p class="description">参加に同意しなかった場合でも不利益は生じません。参加に同意しない場合は、本ページ下部の質問に「同意しない」と回答すると、終了画面に遷移します。または、ブラウザを閉じて終了してください。</p>
  <p class="description text-bold text-red-9">参加に同意し、回答を開始した後であっても、途中で気分が悪くなった等の事情で回答を中断したくなった場合は、いつでも参加を中止することができます。</p>
  <p class="description">その場合、皆さまに不利益が生じることはありません。<span class="text-red-9 text-bold">ただし、回答を完了し報酬を受け取っている場合、同意を撤回することはできません。</span></p>
  <br/>
  <p class="title">【報酬】</p>
  <p class="description">調査参加に伴う報酬を受け取るためには、以下の条件を満たしている必要があります。</p>
  <br/>
  <p class="description">① 本研究への参加に同意している</p>
  <p class="description">② 調査ページが正常に終了し、すべての質問項目への回答が完了している</p>
  <br/>
  <p class="description">以上の条件をすべて満たす方には、<span class="text-bold">回答完了後に個別のID番号が発行されます。</span>これをメモして手元に控えた上で、Lancers上のフォームに入力してください。回答数が募集人数に到達し次第、照合作業をおこないます。照合作業終了後、Lancers上で指定した金額報酬をお支払いいたします。</p>
  <p class="description text-bold text-red-9">なお、明らかに質問を読んでいないと思われる回答がある場合などは、報酬を受け取れません。</p>
  <br/>
  <p class="title">【個人情報の取り扱い】</p>
  <p class="description">回答は無記名で行われます。皆さまの回答は統計的に処理されますので、個人が特定されることは一切ありません。また、報酬支払い手続きのため、回答完了後に個別のID番号が発行されます。ただし、報酬の支払い完了後にIDは削除されるため、以降は回答とユーザ名を対応させることができなくなります。</p>
  <br/>
  <p class="title">【データの保管】</p>
  <p class="description">この調査結果は、当研究室が実施する研究の範囲でのみ使用され、それ以外の目的には使用いたしません。なお、公益財団法人日本心理学会の倫理規定に従い、5年間厳重に保管した後、すみやかにデータを破棄します。</p>
  <br/>
  <p class="title">【本研究に関するお問い合わせ】</p>
  <p class="description">本研究で得られた結果について知りたい場合は、Lancers上のメッセージ機能でご連絡ください。ただし、個人を特定できるデータを保存しない都合上、個⼈データを開⽰することはできません。</p>
  <p class="description">本研究についてご質問がある場合も、Lancers上のメッセージ機能でご連絡ください。</p>
  <br/>
  <p class="title">調査実施機関：</p>
  <p class="description">名古屋大学 大学院情報学研究科</p>
  <p class="description">社会心理学研究室</p>
  <br/>
  <br/>
  <p class="description text-center" style="font-size: 19px;">あなたは上記の説明を理解し、本研究への参加に同意しますか。</p>
  <br/>
  <div class="row">
    <div class="col-2"></div>
    <div class="col-4" align="center" :style="radioAgree === '1' ? 'background-color: #CCEBFF; border: 5px solid white;': 'background: rgba(0,0,0,.08); border: 5px solid white;'">
      <p class="description" style="font-size: 19px;">同意する</p>
      <q-radio 
        v-model="radioAgree" 
        size="xl" 
        checked-icon="task_alt" 
        unchecked-icon="panorama_fish_eye" 
        val="1"
      />
    </div>
    <div class="col-4" align="center" :style="radioAgree === '0' ? 'background-color: #CCEBFF; border: 5px solid white;': 'background: rgba(0,0,0,.08); border: 5px solid white;'">
      <p class="description" style="font-size: 19px;">同意しない</p>
      <q-radio 
        v-model="radioAgree" 
        size="xl" 
        checked-icon="task_alt" 
        unchecked-icon="panorama_fish_eye" 
        val="0"
      />
    </div>
  </div>
  <div class="q-mt-xl" align="right">
      <q-btn 
        v-if="radioAgree === ''"
        label="次のページへ"
        flat
        :ripple="false"
        class="bg-grey text-white"
      ></q-btn>
      <q-btn 
        v-else
        label="次のページへ"
        flat
        class="bg-blue-7 text-white"
        @click="toPage2"
      ></q-btn>
  </div>
</template>
<script setup  lang="ts">
import { ref, onMounted, defineProps, withDefaults } from "vue";
import uuid from "node-uuid";

//ページ読み込み時にUUIDと開始時間とIPアドレスを取得
onMounted(async()=>{
  UUID.value = uuid.v4();
  //開始時間
  startDateTime.value = new Date().toLocaleString("ja-JP", {timeZone: "Asia/Tokyo", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", second: "2-digit"}).replace(/\//g, '-');
  //IPアドレス
  await fetch('https://api.ipify.org?format=json')
    .then(response => response.json())
    .then(data => {
      ipAddress.value = data.ip;
    })
    .catch(error => {
      ipAddress.value = 'none';
    });
});

//親からの受け取りデータ
const props = defineProps(['uri']);

//変数
const radioAgree = ref<string>('');
const UUID = ref<string>('')
const startDateTime = ref<string>('');
const ipAddress = ref<string>('');

//次のページへ
const toPage2 = function(){
  window.scrollTo(0, 0);
  const body: string = `start=${startDateTime.value}&ipAddress=${ipAddress.value}&agreeParticipate=${radioAgree.value}`;
  postData('page1', body);
  execEmit();
};

const emit = defineEmits(['eventEmit'])
const execEmit = () => {
  //実験参加へ同意する場合
  if(radioAgree.value === '1'){
    emit('eventEmit', { 'tab': 'page2', 'progress': 0.05, 'UUID': UUID.value});
    
  //実験参加へ同意しない場合は強制終了
  }else{
    emit('eventEmit', { 'tab': 'forcedEnd', 'progress': 1.0, 'UUID': UUID.value});
  }
}

//データを送信する関数
const postData = async(route: string, body: string) => {
  
  //GASにリクエストを送る
	const requestOptions: any = {
		method: 'POST',
		headers: {
			'Content-Type': 'application/x-www-form-urlencoded',
		},
		body: `route=${route}&uuid=${UUID.value}&` + body,
	};

	let result: string = '';

	await fetch(props.uri, requestOptions)
		.then(async(res) => {
      const data = await res.json();
      
      //成功したとき
      if(data.type === 'complete'){
        result = 'complete';
      
      //エラーが発生したとき
      }else{

        //エラー用リクエスト
        const requestOptionsError: any = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `route=error&uuid=${UUID.value}&dateTime=${new Date().toLocaleString("ja-JP", {timeZone: "Asia/Tokyo", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", second: "2-digit"}).replace(/\//g, '-')}&error=リクエストエラー&page=${route}&data=${body}`,
        };

        await fetch(props.uri, requestOptionsError)
          .then((res) => {
            console.log(res.json());
            result = 'error';
          });
        }
    })
		.catch(async(err) => {

      //エラー用リクエスト
      const requestOptionsError: any = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `route=error&uuid=${UUID.value}&dateTime=${new Date().toLocaleString("ja-JP", {timeZone: "Asia/Tokyo", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", second: "2-digit"}).replace(/\//g, '-')}&error=${err}&page=${route}&data=${body}`,
      };

      await fetch(props.uri, requestOptionsError)
        .then((res) => {
          console.log(res.json());
          result = 'error';
        });
    });

  return result;
};

</script>
<style lang="scss">

</style>